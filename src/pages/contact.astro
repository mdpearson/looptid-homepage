---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout frontmatter={{ title: 'Contact' }}>
  <h2>Get in Touch</h2>

  <p>
    I’m currently accepting new projects and would be glad to discuss how I can
    help your organization. Please fill out the form below and I’ll respond
    within a business day or two.
  </p>

<form id="contact-form" method="POST" action="/api/contact">
  <div class="form-group">
    <label for="name">Name *</label>
    <input type="text" id="name" name="name" required />
  </div>

  <div class="form-group">
    <label for="email">Email *</label>
    <input type="email" id="email" name="email" required />
  </div>

  <div class="form-group">
    <label for="organization">Organization</label>
    <input type="text" id="organization" name="organization" />
  </div>

  <div class="form-group">
    <label for="message">Message *</label>
    <textarea id="message" name="message" rows="6" required></textarea>
  </div>

  <div class="cf-turnstile" data-sitekey="0x4AAAAAACCEERxbA1FP0hTE"></div>

  <button type="submit">Send Message</button>

  <div id="form-status" aria-live="polite"></div>
</form>

<script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  const form = document.getElementById("contact-form") as HTMLFormElement | null;
  const status = document.getElementById("form-status");

  // Extend Window interface for Turnstile
  declare global {
    interface Window {
      turnstile?: {
        reset: () => void;
      };
    }
  }

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = "Sending...";
    }

    const formData = new FormData(form);

    // Get the Turnstile token
    const turnstileInput = document.querySelector('[name="cf-turnstile-response"]') as HTMLInputElement | null;
    const turnstileToken = turnstileInput?.value;
    if (!turnstileToken) {
      if (status) {
        status.textContent = "Please complete the security check.";
        status.className = "error";
      }
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = "Send Message";
      }
      return;
    }

    // Build data object explicitly
    const data = {
      "cf-turnstile-response": turnstileToken,
      email: formData.get("email"),
      message: formData.get("message"),
      name: formData.get("name"),
      organization: formData.get("organization") || ""
    };

    try {
      const response = await fetch("/api/contact", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        if (status) {
          status.textContent = "Thank you! Your message has been sent. We’ll talk soon.";
          status.className = "success";
        }
        form.reset();
      } else {
        const error = await response.json() as { message?: string };
        console.error("Mail server error:", response.status, error);
        if (status) {
          status.textContent = error.message || `Mail server rejected the form (error ${response.status}).`;
          status.className = "error";
        }
      }
    } catch (err) {
      console.error("Network error:", err);
      if (status) {
        status.textContent = "Unable to contact the mail server.";
        status.className = "error";
      }
    } finally {
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = "Send Message";
      }
      // Reset Turnstile widget
      if (window.turnstile) {
        window.turnstile.reset();
      }
    }
  });
</script>

<style>
  .cf-turnstile {
    margin: 1.5rem 0;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  #form-status {
    border-radius: 0.25rem;
    margin-top: 1rem;
    padding: 1rem;
  }

  #form-status:empty {
    display: none;
  }

  #form-status.error {
    background: var(--error-bg);
    border: 1px solid var(--error-border);
    color: var(--error-text);
  }

  #form-status.success {
    background: var(--success-bg);
    border: 1px solid var(--success-border);
    color: var(--success-text);
  }
</style>
</BaseLayout>
